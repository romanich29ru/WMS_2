# WMS v2.0 - План Доработок и Расширений

## 1. СИНХРОНИЗАЦИЯ ТЕЛЕФОН ↔ ПК (Real-Time)

### 1.1 Требования
- Телефон (инспектор) проверяет ячейки в реальном времени
- ПК (менеджер) видит все изменения live
- Двусторонняя синхронизация при онлайне
- Офлайн кэширование (продолжение работы без интернета)

### 1.2 Архитектурные варианты

#### Вариант A: Firebase Realtime Database (рекомендуется)
**Плюсы:**
- Встроенная real-time синхронизация
- Бесплатный тариф на начало
- Легко масштабируется
- Автоматическое управление конфликтами

**Минусы:**
- Нужна регистрация в Google Cloud
- Данные на серверах Google

**Стоимость:** Бесплатно до 100 параллельных подключений

#### Вариант B: Supabase (PostgreSQL + Realtime)
**Плюсы:**
- Open source, полный контроль
- PostgreSQL мощнее
- Можно развернуть на своем сервере

**Минусы:**
- Требует настройки сервера
- Сложнее в развертывании

#### Вариант C: WebSocket + Node.js Backend
**Плюсы:**
- Максимальный контроль
- Можно хостить на любом сервере

**Минусы:**
- Нужно разрабатывать весь backend
- Требует DevOps опыта

### 1.3 Структура данных для синхронизации

```javascript
// Новая структура с версионированием
warehouseSync = {
  userId: "operator_id",
  sessionId: "unique_session",
  deviceType: "mobile" | "desktop",
  lastSyncTime: 1707000000000,
  changes: [
    {
      cellId: "A01-01-15-A",
      timestamp: 1707000000000,
      change: {
        actualStatus: "checked-empty",
        oldStatus: null,
        systemStatus: "occupied",
        discrepancy: true,
        articlesCount: 1,
        expectedArticlesCount: 2,
        photos: ["base64..."],
        operator: "Ivan"
      },
      deviceId: "mobile_device_123",
      syncStatus: "synced" | "pending" | "conflict"
    }
  ]
}
```

## 2. РЕЖИМ МОНИТОРИНГА НА ПК (Полная топология)

### 2.1 Требования
- Отображение ВСЕХ 405 ячеек аллеи одновременно (15 секций × 27 ячеек)
- Real-time обновление статусов при изменениях на телефоне
- Легкое определение проблемных зон
- Фильтры по статусу

### 2.2 Визуальное отображение

```
АЛЛЕЯ A01 - РЕЖИМ МОНИТОРИНГА
┌─────────────────────────────────────────────┐
│  Секция  │ Ячейки (27 на секцию)            │
├─────────────────────────────────────────────┤
│   01     │ ██ ░░ ██ ░░ ░░ ░░ ░░ ░░ ░░ ... │
│   02     │ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ... │
│   03     │ ██ ██ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ... │
│  ...     │ ...                              │
│   15     │ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ░░ ... │
└─────────────────────────────────────────────┘

Легенда:
██ = Проверена, OK
░░ = Проверена, Расхождение
⚠️ = Проверена, Ошибка артикулов
❌ = Ошибка
🔄 = Проверяется сейчас (на телефоне)
⬜ = Не проверена
```

### 2.3 Интерактивность
- Клик на ячейку → открыть статус и фото в popup
- Фильтры: Все / Проверены / Расхождения / Ошибки артикулов
- Поиск по ячейке (A01-05-11-B)
- Zoom in/out для больших аллеей

## 3. РАБОТА С АРТИКУЛАМИ В XLS

### 3.1 Расширенный XLS формат

**Колонки для импорта:**
```
Column A: Название Ячейки (A01-01-15-A)
Column B: Статус (empty/occupied)
Column C: Кол-во артикулов (количество)
Column D: Артикулы (артикул1, артикул2, артикул3)
Column E: Комментарий (опционально)
```

**Пример:**
```
Название Ячейки | Статус  | Кол-во артикулов | Артикулы
A01-01-15-A    | occupied| 2                | ART001, ART002
A01-01-14-B    | empty   | 0                | -
A01-01-13-C    | occupied| 1                | ART005
```

### 3.2 Новая структура данных ячейки

```javascript
cell = {
  id: "A01-01-15-A",
  alley: "A01",
  section: "01",
  tier: "15",
  position: "A",
  
  // WMS данные
  systemStatus: "occupied",
  expectedArticlesCount: 2,
  articles: [
    { code: "ART001", description: "Товар 1", quantity: 1 },
    { code: "ART002", description: "Товар 2", quantity: 1 }
  ],
  
  // Инспекция
  actualStatus: null,
  actualArticlesCount: null,
  actualArticles: [], // Что инспектор найдет на самом деле
  checked: false,
  checkTime: null,
  operator: "",
  
  // Ошибки
  articlesError: false, // true если фактическое ≠ ожидаемому
  errorDetails: {
    expected: 2,
    actual: 1,
    missing: ["ART002"],
    extra: []
  },
  
  photos: [],
  discrepancy: false,
  comments: ""
}
```

### 3.3 Логика проверки артикулов

```javascript
function validateArticles(cell) {
  if (!cell.expectedArticlesCount || cell.expectedArticlesCount === 0) {
    // Ячейка должна быть пустой
    return {
      hasError: cell.actualArticlesCount > 0,
      type: "empty_but_has_items"
    };
  }
  
  if (cell.actualArticlesCount === null) {
    // Инспектор не ввел данные
    return {
      hasError: true,
      type: "not_inspected",
      message: "Требуется физическая проверка кол-ва артикулов"
    };
  }
  
  const expectedCount = cell.articles.length;
  const actualCount = cell.actualArticlesCount;
  
  if (expectedCount !== actualCount) {
    return {
      hasError: true,
      type: "count_mismatch",
      expected: expectedCount,
      actual: actualCount,
      message: `Ожидалось ${expectedCount} артикулов, найдено ${actualCount}`
    };
  }
  
  // Проверка конкретных артикулов (если инспектор их указал)
  if (cell.actualArticles && cell.actualArticles.length > 0) {
    const expectedCodes = cell.articles.map(a => a.code);
    const actualCodes = cell.actualArticles.map(a => a.code);
    const missing = expectedCodes.filter(c => !actualCodes.includes(c));
    const extra = actualCodes.filter(c => !expectedCodes.includes(c));
    
    if (missing.length > 0 || extra.length > 0) {
      return {
        hasError: true,
        type: "articles_mismatch",
        missing,
        extra,
        message: `Неверные артикулы. Не хватает: ${missing.join(", ")} Лишние: ${extra.join(", ")}`
      };
    }
  }
  
  return {
    hasError: false,
    type: "ok",
    message: "ОК"
  };
}
```

## 4. МОДАЛЬНОЕ ОКНО ПРОВЕРКИ С АРТИКУЛАМИ

### 4.1 Новый дизайн модального окна

```
┌─────────────────────────────────────────┐
│  Ячейка A01-01-15-A                    │
├─────────────────────────────────────────┤
│ ОЖИДАЕМЫЕ ДАННЫЕ:                       │
│  Статус: ЗАНЯТА                         │
│  Кол-во артикулов: 2                    │
│  Артикулы:                              │
│   • ART001 - Товар 1 (Кол-во: 1)       │
│   • ART002 - Товар 2 (Кол-во: 1)       │
├─────────────────────────────────────────┤
│ ФАКТИЧЕСКАЯ ПРОВЕРКА:                   │
│                                         │
│  Статус системы: ЗАНЯТА ⚠️              │
│                                         │
│  ⚠️ ВНИМАНИЕ: Ячейка содержит          │
│  2 артикула - требуется проверка!     │
│                                         │
│  Сколько артикулов найдено физически?  │
│  [Введите количество: ___] (0-5)       │
│                                         │
│  Укажите найденные артикулы:           │
│  ☐ ART001 - Товар 1                    │
│  ☐ ART002 - Товар 2                    │
│  [+ Добавить другой артикул]           │
│                                         │
│ ФОТО ЯЧЕЙКИ:                           │
│ [Сделать фото] [Загрузить]             │
│                                         │
│  ВЫВОД:                                │
│  [ Пустая ] [ Занята ✓ ] [ Ошибка ✗ ] │
│  [ Пропустить ]                        │
└─────────────────────────────────────────┘
```

## 5. ФАЙЛ КОНФИГУРАЦИИ ДЛЯ ОБЛАЧНОГО ХРАНИЛИЩА

Новый файл: `config/sync-config.js`

```javascript
// Выбор backend'а
const SYNC_BACKEND = 'firebase'; // 'firebase' | 'supabase' | 'websocket'

const SYNC_CONFIG = {
  firebase: {
    apiKey: "YOUR_API_KEY",
    projectId: "wms-warehouse",
    databaseURL: "https://wms-warehouse.firebaseio.com",
    enabled: false // Включить после настройки
  },
  supabase: {
    url: "https://your-project.supabase.co",
    anonKey: "YOUR_ANON_KEY",
    enabled: false
  },
  websocket: {
    url: "wss://your-backend.com/ws",
    enabled: false
  }
};
```

## 6. ШАГИ РЕАЛИЗАЦИИ

### Этап 1: Структура данных (1-2 часа)
1. Расширить модель `cell` для артикулов
2. Создать функции валидации артикулов
3. Обновить localStorage структуру

### Этап 2: XLS парсинг (1-2 часа)
1. Расширить `parseXLSFile()` для чтения артикулов
2. Добавить валидацию новых колонок
3. Тестирование на примерах XLS

### Этап 3: UI на телефоне (2-3 часа)
1. Обновить модальное окно проверки
2. Добавить выбор артикулов
3. Реализовать валидацию при сохранении

### Этап 4: Режим мониторинга на ПК (3-4 часа)
1. Создать новый режим просмотра (grid всей аллеи)
2. Реализовать фильтры и поиск
3. Стилизация и UX

### Этап 5: Real-time синхронизация (4-6 часов)
1. Выбрать и настроить Firebase (рекомендуется)
2. Реализовать отправку изменений
3. Реализовать прием обновлений в real-time
4. Обработка конфликтов синхронизации

### Этап 6: Тестирование и оптимизация (2-3 часа)
1. Unit тесты для валидации
2. Интеграционные тесты
3. Performance тестирование

## 7. ПРИМЕРНЫЕ СРОКИ
- **Быстрая версия** (без синхронизации): 5-7 часов
- **Полная версия** (с Firebase): 12-15 часов

## 8. АЛЬТЕРНАТИВНЫЙ ПОДХОД (Более простой)

Если не нужна live синхронизация, можно сделать:
1. **Локальная версия**: Все данные синхронизируются через QR код или NFC
2. **Периодическая синхронизация**: Телефон отправляет данные на ПК раз в N минут
3. **Manual sync**: Оператор нажимает "Синхронизировать" после проверки секции

Это более простой в реализации подход, требующий 5-8 часов.

---

## ВЫВОДЫ И РЕКОМЕНДАЦИИ

### Что реализовать сначала (MVP):
1. ✅ Расширенный XLS с артикулами
2. ✅ Валидация артикулов при проверке
3. ✅ Режим мониторинга на ПК (полная топология)
4. ⏳ Real-time синхронизация (Firebase) - добавить позже

### Технологический стек:
- **Frontend**: Чистый JS (текущий подход)
- **Storage**: localStorage (текущий) + Firebase (опционально)
- **Синхронизация**: Firebase Realtime DB или WebSocket

### Бюджет:
- Разработка (часы): 12-15 часов
- Firebase: Бесплатно (до определенного лимита)
- Хостинг: Уже на Vercel (не требует изменений)
